[pycsw_build]

parts =
    pycsw
    pycsw_python
    pycsw_config
    pycsw_logrotate
    pycsw_repository
    pycsw_gunicorn
    pycsw_supervisor
    pycsw_deploy

[pycsw]
recipe = z3c.recipe.scripts
eggs =
    pycsw
home = ${install:prefix}/var/lib/pycsw
cfg = ${install:prefix}/etc/pycsw.cfg
server = unix:${install:prefix}/var/run/pycsw.socket
log_file = ${install:prefix}/var/log/pycsw.log

[pycsw_python]
recipe = z3c.recipe.scripts
eggs =
    ${pycsw:eggs} 
interpreter = python_pycsw

[pycsw_config]  
recipe = collective.recipe.template
input = ${buildout:directory}/templates/pycsw.cfg.in
output = ${buildout:parts-directory}/pycsw/pycsw.cfg

[pycsw_logrotate]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/logrotate.in
output = ${buildout:parts-directory}/pycsw/logrotate

log_file = ${pycsw:log_file}

[pycsw_repository]
recipe = collective.recipe.cmd
on_install = true
on_update = true
cmds =
    if [ ! -d  ${pycsw:home} ]; then
       sudo mkdir -p ${pycsw:home}
       sudo cp -r ${buildout:directory}/src/pycsw/tests ${pycsw:home}
    fi
    sudo chown -R ${install:user}:${install:group} ${pycsw:home}

[pycsw_gunicorn]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/gunicorn.conf.py.in
output = ${buildout:parts-directory}/pywps/gunicron.conf.py

bind = ${pycsw:server}

[pycsw_supervisor]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/supervisor.conf.in
output = ${buildout:parts-directory}/pycsw/supervisor.conf

program = pycsw
command = ${buildout:bin-directory}/python_pywps ${buildout:bin-directory}/gunicorn csw_wsgi_gunicorn:application -c ${install:prefix}/etc/gunicorn_pycsw.conf.py
directory = ${buildout:directory}/src/pycsw/
priority = 20
environment=PYCSW_CONFIG="${pycsw:cfg}"

[pycsw_deploy]
recipe = collective.recipe.cmd
on_install = true
on_update = true
cmds =
    sudo cp ${buildout:parts-directory}/pycsw/pycsw.cfg ${pycsw:cfg}
    sudo cp ${pycsw_gunicorn:output} ${install:prefix}/etc/gunicorn_pycsw.conf.py
    sudo cp ${buildout:parts-directory}/pycsw/supervisor.conf /etc/supervisor/conf.d/pycsw.conf
    sudo cp ${buildout:parts-directory}/pycsw/logrotate /etc/logrotate.d/pycsw
    
