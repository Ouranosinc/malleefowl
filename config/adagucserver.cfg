[buildout]
parts += 
      postgres_conda
      postgres_initdb
      postgres_config
      postgres_supervisor
      adagucserver_conda
      adagucserver_app
      adagucserver_config
      adagucserver_postgres
      adagucserver_gunicorn
      adagucserver_supervisor
      adagucserver_nginx

[adagucserver_conda]
recipe = birdhousebuilder.recipe.conda
pkgs = 
     adagucserver

[postgres_conda]
recipe = birdhousebuilder.recipe.conda
pkgs = postgresql

[postgres_initdb]
recipe = collective.recipe.cmd
on_install = true
cmds =
     test -d ${buildout:anaconda-home}/var/lib/postgres || ${buildout:anaconda-home}/bin/initdb --auth=trust -D ${buildout:anaconda-home}/var/lib/postgres

[postgres_config]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/postgresql.conf
output = ${buildout:anaconda-home}/var/lib/postgres/postgresql.conf

port = 5432

[postgres_supervisor]
recipe = birdhousebuilder.recipe.supervisor

program = postgres
command = ${buildout:anaconda-home}/bin/postgres -D ${buildout:anaconda-home}/var/lib/postgres
directory = ${buildout:anaconda-home}/var/lib/postgres

[adagucserver_app]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/adagucserver.py
output = ${buildout:anaconda-home}/etc/adagucserver/adagucserver.py

prefix = ${buildout:anaconda-home}

[adagucserver_config]
recipe = collective.recipe.template[genshi]:genshi
input = ${buildout:directory}/templates/autowms.xml
output = ${buildout:anaconda-home}/etc/adagucserver/autowms.xml

prefix = ${buildout:anaconda-home}
online_resource = http://${settings:hostname}:8001/?
font = ${buildout:anaconda-home}/share/adagucserver/fonts/FreeSans.ttf
db_params = dbname=adagucdemo host=127.0.0.1 user=adaguc password=
data_dir = ${buildout:anaconda-home}/var/cache/pywps

[adagucserver_postgres]
recipe = collective.recipe.cmd
on_install = true
cmds =
     ${buildout:anaconda-home}/bin/supervisorctl restart ${postgres_supervisor:program}
     ${buildout:anaconda-home}/bin/createuser -p 5432 --createdb --no-createrole --no-superuser --login adaguc
     ${buildout:anaconda-home}/bin/createdb -p 5432 --owner=adaguc adaguc

[adagucserver_gunicorn]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/gunicorn.conf.py
output = ${buildout:anaconda-home}/etc/adagucserver/gunicorn.conf.py

prefix = ${buildout:anaconda-home}

[adagucserver_supervisor]
recipe = birdhousebuilder.recipe.supervisor

program = adagucserver
command = ${buildout:anaconda-home}/bin/gunicorn adagucserver:app -c ${adagucserver_gunicorn:output}
directory = ${buildout:anaconda-home}/etc/adagucserver

[adagucserver_nginx]
recipe = birdhousebuilder.recipe.nginx
input = ${buildout:directory}/templates/nginx.conf
sites = adagucserver

hostname =  ${settings:hostname}
port = 8001


