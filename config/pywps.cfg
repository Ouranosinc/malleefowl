[buildout]

parts += 
    htmltmpl
    pywps_checkout
    PyWPS   
    pywps_python
    pywps_config
    pywps_logrotate
    pywps_gunicorn
    pywps_supervisor
    pywps_nginx
    pywps_deploy

[htmltmpl]
recipe = z3c.recipe.scripts
find-links = http://sourceforge.net/projects/htmltmpl/files/htmltmpl/1.22/htmltmpl-1.22.tar.gz/download#egg=htmltmpl-1.22
eggs = htmltmpl

[pywps_checkout]
recipe = collective.recipe.cmd
on_install = true
on_update = true
cmds =
     target=${buildout:directory}/src/PyWPS
     address=https://github.com/cehbrecht/PyWPS.git
     branch=master
     if [ -d $target ] 
        then 
            cd $target
            git pull
            cd -
        else
            git clone $address $target -b $branch
     fi

[PyWPS]
recipe = zc.recipe.egg:develop
setup = ${buildout:directory}/src/PyWPS/setup.py
eggs =
    PyWPS
    lxml
    htmltmpl
    python-magic
    ordereddict

[pywps]
home = ${conda:home}/var/lib/pywps
socket = ${conda:home}/var/run/pywps.socket
log_file = ${conda:home}/var/log/pywps/pywps.log

[pywps_python]
recipe = z3c.recipe.scripts
eggs =
    ${PyWPS:eggs} 
    ${malleefowl:eggs}
interpreter = python

[pywps_config]  
recipe = collective.recipe.template
input = ${buildout:directory}/templates/pywps.cfg.in
output = ${conda:home}/etc/pywps.cfg

processes_path = ${buildout:directory}/processes
output_path = ${pywps:home}/outputs
temp_path = ${pywps:home}/temp
cache_path = ${pywps:home}/cache
log_path = ${conda:home}/var/log/pywps
files_path = ${pywps:home}/files
files_url = http://${server:hostname}:${ports:http}/files
malleefowl_path = ${buildout:directory}
integration_tests = ${buildout:directory}/unit_tests

[pywps_logrotate]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/logrotate.in
output = ${conda:home}/etc/logrotate_pywps

log_file=${pywps:log_file}

[pywps_gunicorn]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/gunicorn.conf.py
output = ${conda:home}/etc/gunicorn.conf.py

bind = unix://${pywps:socket}

[pywps_supervisor]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/supervisor.conf
output = ${conda:home}/etc/supervisor/conf.d/pywps.conf

program = pywps
command = ${buildout:bin-directory}/python ${buildout:bin-directory}/gunicorn wsgiwps:application -c ${conda:home}/etc/gunicorn.conf.py
directory = ${buildout:directory}/src/PyWPS/webservices/wsgi
priority = 20
environment = 

[pywps_nginx]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/nginx-malleefowl.conf
output = ${conda:home}/etc/nginx/sites-enabled/malleefowl


[pywps_deploy]
recipe = collective.recipe.cmd
on_install = true
on_update = true
cmds =
    mkdir -p ${conda:home}/var/log/pywps      
    sudo cp ${pywps_logrotate:output} /etc/logrotate.d/pywps

   

