[buildout]

parts +=
    nginx_install
    nginx_config
    nginx_ssl
    nginx_supervisor
   

[nginx_install]
recipe = collective.recipe.cmd
on_install = true
on_update = false
cmds =
     $HOME/.linuxbrew/bin/brew install nginx
     mkdir -p ${conda:home}/var/cache/nginx

[nginx_config]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/nginx.conf
output = ${conda:home}/etc/nginx/nginx.conf
user = www-data

[nginx_ssl]
recipe = collective.recipe.cmd
on_install = true
on_update = false
cmds =
     openssl req -batch -x509 -nodes -days 365 \
        -subj '/C=DE/ST=Hamburg/L=Hamburg/O=Phoenix/CN=${server:hostname}' \
        -newkey rsa:1024 \
        -keyout ${conda:home}/etc/nginx/phoenix.cert \
        -out ${conda:home}/etc/nginx/phoenix.cert

[nginx_supervisor]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/supervisor.conf
output = ${conda:home}/etc/supervisor/conf.d/nginx.conf

program = nginx
command = /opt/homebrew/bin/nginx -c ${nginx_config:output} -g "daemon off;"
directory =  ${conda:home}/bin
priority = 90
environment = PATH="/opt/homebrew/bin",LD_LIBRARY_PATH="/opt/homebrew/lib:${conda:home}/lib"





