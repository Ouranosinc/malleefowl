[buildout]

parts +=
      supervisor_debian
      supervisor_redhat
      supervisor_config
      supervisor_deploy

[supervisor_debian]
recipe = collective.recipe.cmd
on_install = true
cmds =
    if [ -f /etc/debian_version ] ; then
        sudo apt-get -y --force-yes install supervisor
    fi

[supervisor_redhat]
recipe = collective.recipe.cmd
on_install = true
cmds =
    if [ -f /etc/redhat-release ] ; then
        sudo /opt/anaconda/bin/pip install supervisor --pre
    fi

[supervisor_config]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/supervisord.conf.in
output = ${buildout:parts-directory}/supervisor/supervisord.conf

[supervisor_deploy]
recipe = collective.recipe.cmd
on_install = true
on_update = true
cmds =
     if [ -f /etc/debian_version ] ; then
       sudo cp ${supervisor_config:output} /etc/supervisor/supervisord.conf
       sudo supervisorctl reload           
     fi
     if [ -f /etc/redhat-release ] ; then
       sudo mkdir -p /etc/supervisor/conf.d
       sudo cp ${supervisor_config:output} /etc/supervisor/supervisord.conf
       sudo /opt/anaconda/bin/supervisord -c /etc/supervisor/supervisord.conf
       sudo /opt/anaconda/bin/supervisorctl restart all
     fi
